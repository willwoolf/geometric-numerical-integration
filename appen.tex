\appendix

\section{Symplectic Integration}

\section{Positivity Preservation}

\subsection{Convex Optimisation for ES2}

Denote a vector $g$ of the elements which appear in the expansions of $x(t_n+h)$ and its approximations.
\begin{equation*}
    g := \begin{pmatrix}
        A'' Ax Ax x \\
        A' A' A xxx \\
        A' A^2 xx \\
        A' Ax Ax \\
        A A' A xx \\
        A^3 x
    \end{pmatrix}.
\end{equation*}
We ignore the fact that this is a vector of vectors which is technically not defined.
We denote it as a vector in order to write linear combinations of elements as vector inner products. %dangerous
Define the following vectors
\begin{align*}
    v &:= \begin{pmatrix}
        \frac{1}{6} & \frac{1}{6} & \frac{1}{3} & 0 & \frac{1}{6} & \frac{1}{6}
    \end{pmatrix}^\top \\
    u_z &:= \begin{pmatrix}
        \frac{1}{8} & 0 & \frac{1}{8} & 0 & \frac{1}{4} & \frac{1}{6}
    \end{pmatrix}^\top \\
    u_x &:= \begin{pmatrix}
        0 & \frac{1}{4} & \frac{1}{4} & \frac{3}{8} & \frac{1}{8} & \frac{1}{6}
    \end{pmatrix}^\top .
\end{align*}
Evaluating $v^\top g$ gives us the expansion of the actual value of $x(t_n+h)$ at order $h^3$.
We also have $u_z^\top g$ and $u_x^\top g$, which are the expansions of the $z$ and $x$ components of the method at the same order.
Let $\mu, \lambda$ be scalars for us to take a linear combination of the $x$ and $z$ methods.
The truncation error, denoted here by $\tau$, is
\begin{align*}
    \tau &= v^\top g - \mu ( u_z^\top g ) - \lambda ( u_x^\top g ) \\
    &= \left( v - \mu u_z - \lambda u_x \right)^\top g.
\end{align*}
This is an inner product of two vectors, so we can apply the Cauchy-Schwarz inequality to obtain the bound
\begin{equation*}
    \tau \leq ||v - \mu u_z - \lambda u_x||_2 \cdot ||g||_2.
\end{equation*}
Arguably, taking the Cauchy-Schwarz inequality is not allowed because $g$ is not a vector in the traditional sense.
However, if we think about it, $g$ must have some norm which is finite so this should be fine. % a problem for future me
Because $g$ is our vector of elements, we can only vary the value of the $2$-norm on the left.
Therefore our problem is of the form
\begin{equation*}
    \text{minimise } ||v - \mu u_z - \lambda u_x||_2.
\end{equation*}
We have the additional contraint that $\mu + \lambda = 1$ in mind, because the method must be second order accurate.
We can block the vectors and scalars to rewrite the problem in the form
\begin{equation*}
    \text{minimise } ||v - \begin{bmatrix}
        u_z & u_x
    \end{bmatrix} \begin{pmatrix}
        \mu \\
        \lambda
    \end{pmatrix}||_2.
\end{equation*}
The solution to this optimisation problem \cite{boyd2004convex} is the solution to the normal equations
\begin{equation*}
    \begin{bmatrix}
        u_z^\top \\
        u_x^\top
    \end{bmatrix} v - \begin{bmatrix}
        u_z^\top \\
        u_x^\top
    \end{bmatrix} \begin{bmatrix}
        u_z & u_x
    \end{bmatrix} \begin{pmatrix}
        \mu \\
        \lambda
    \end{pmatrix} = 0.
\end{equation*}
which rearranges to
\begin{equation*}
    \begin{bmatrix}
        u_z^\top u_z & u_z^\top u_x \\
        u_x^\top u_z & u_x^\top u_x
    \end{bmatrix} \begin{pmatrix}
        \mu \\
        \lambda
    \end{pmatrix} = \begin{bmatrix}
        u_z^\top v \\
        u_x^\top v
    \end{bmatrix}.
\end{equation*}
Numerically, this can be represented as
\begin{equation*}
    \begin{bmatrix}
        35 & 26 \\
        26 & 89
    \end{bmatrix} \begin{pmatrix}
        \mu \\
        \lambda
    \end{pmatrix} = \begin{bmatrix}
        38 \\
        50
    \end{bmatrix}
\end{equation*}
having been scaled up by a factor of $288$.
Since we must satisfy the linear constraint, we can't directly solve this system.
With the residual defined as
\begin{equation*}
    r = \begin{pmatrix}
        38 \\
        50
    \end{pmatrix} - \begin{bmatrix}
        35 & 26 \\
        26 & 89
    \end{bmatrix} \begin{pmatrix}
        \mu \\
        \lambda
    \end{pmatrix}
\end{equation*}
we can write its squared norm as
\begin{align*}
    ||r||_2^2 &= \left( 38 - 35 \mu - 26 \lambda \right)^2 + \left( 50 - 26 \mu - 89 \lambda \right)^2 \\
    &= 1901 \mu^2 + 6448 \mu \lambda + 8597 \lambda^2 - 5260 \mu - 10876 \lambda + 3944
\end{align*}
The Lagrangian takes the form $L(\mu, \lambda, k) = ||r||_2^2 + k (\lambda + \mu - 1)$, the objective function plus a Lagrange multiplier $k$ times the constraint function.
Then
\begin{align*}
    \frac{\partial L}{\partial \mu} &= 3802 \mu + 6448 \lambda - 5260 + k \\
    \frac{\partial L}{\partial \lambda} &= 6448 \mu + 17194 \lambda - 10876 + k \\
    \frac{\partial L}{\partial k} &= \lambda + \mu - 1.
\end{align*}
The minimiser of the Lagrangian is the solution to the linear system
\begin{equation*}
    \begin{bmatrix}
        3802 & 6448 & 1 \\
        6448 & 17194 & 1 \\
        1 & 1 & 0
    \end{bmatrix} \begin{pmatrix}
        \mu \\
        \lambda \\
        k
    \end{pmatrix} = \begin{pmatrix}
        5260 \\
        10876 \\
        1
    \end{pmatrix}
\end{equation*}
which has the solution
\begin{align*}
    \mu &= \frac{19}{30} \\
    \lambda &= \frac{11}{30} \\
    k &= \frac{2439}{5}.
\end{align*}


\section{MATLAB Implementations}